name: ðŸš€ Deploy NEXUS BUILDING SOLUTION

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  SERVER_HOST: 144.91.66.246
  SERVER_USER: ndongo
  DEPLOY_PATH: /home/ndongo/apps/nexusgroup

jobs:
  # ============================================
  # JOB 1: Tests Backend
  # ============================================
  test-backend:
    name: ðŸ§ª Test Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Install dependencies
        working-directory: ./nexus-backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx
      
      - name: âœ… Run tests
        working-directory: ./nexus-backend
        run: |
          echo "Tests backend OK (Ã  implÃ©menter)"
          # pytest tests/ -v

  # ============================================
  # JOB 2: Build Frontend
  # ============================================
  build-frontend:
    name: ðŸ—ï¸ Build Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ./nexus-frontend/package-lock.json
      
      - name: ðŸ“¦ Install dependencies
        working-directory: ./nexus-frontend
        run: npm ci
      
      - name: ðŸ—ï¸ Build
        working-directory: ./nexus-frontend
        run: npm run build
      
      - name: âœ… Build successful
        run: echo "Frontend build OK"

  # ============================================
  # JOB 3: Deploy to VPS
  # ============================================
  deploy:
    name: ðŸš€ Deploy to VPS
    runs-on: ubuntu-latest
    needs: [test-backend, build-frontend]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: ðŸš€ Deploy
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            
            echo "ðŸ“¥ Pulling latest changes..."
            git -C nexus-frontend pull origin main || true
            git -C nexus-backend pull origin main || true
            git pull origin main || true
            
            echo "ðŸ—ï¸ Building containers..."
            docker compose build --no-cache
            
            echo "ðŸš€ Deploying..."
            docker compose up -d
            
            echo "ðŸ§¹ Cleanup..."
            docker image prune -f
            
            echo "âœ… Deployment complete!"
            docker ps
          EOF
      
      - name: âœ… Deployment successful
        run: echo "ðŸŽ‰ NEXUS BUILDING SOLUTION deployed successfully!"

  # ============================================
  # JOB 4: Health Check
  # ============================================
  health-check:
    name: ðŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: ðŸ¥ Check Frontend
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ env.SERVER_HOST }}/)
          if [ $response -eq 200 ]; then
            echo "âœ… Frontend OK (HTTP $response)"
          else
            echo "âŒ Frontend ERROR (HTTP $response)"
            exit 1
          fi
      
      - name: ðŸ¥ Check Backend API
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ env.SERVER_HOST }}/api/v1/auth/roles)
          if [ $response -eq 200 ] || [ $response -eq 401 ]; then
            echo "âœ… Backend API OK (HTTP $response)"
          else
            echo "âŒ Backend API ERROR (HTTP $response)"
            exit 1
          fi
      
      - name: ðŸŽ‰ All checks passed
        run: echo "ðŸŽ‰ All health checks passed!"
