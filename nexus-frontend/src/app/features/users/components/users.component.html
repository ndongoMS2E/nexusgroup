<div class="users-container">
  <!-- Header -->
  <div class="page-header">
    <h1>üë• Gestion des Utilisateurs</h1>
    <button class="btn-primary" (click)="openCreateModal()">
      ‚ûï Nouvel Utilisateur
    </button>
  </div>

  <!-- Filtres -->
  <div class="filters">
    <input 
      type="text" 
      placeholder="üîç Rechercher..." 
      [(ngModel)]="searchTerm"
      (ngModelChange)="applyFilters()"
      class="search-input"
    />
    <select [(ngModel)]="selectedRole" (ngModelChange)="applyFilters()" class="role-filter">
      <option value="">Tous les r√¥les</option>
      <option *ngFor="let role of roles" [value]="role.code">
        {{ role.icon }} {{ role.name }}
      </option>
    </select>
  </div>

  <!-- Stats -->
  <!-- Stats -->
  <div class="stats-row">
    <div class="stat-card">
      <span class="stat-value">{{ users.length }}</span>
      <span class="stat-label">Total</span>
    </div>
    <div class="stat-card active">
      <span class="stat-value">{{ activeUsersCount }}</span>
      <span class="stat-label">Actifs</span>
    </div>
    <div class="stat-card inactive">
      <span class="stat-value">{{ inactiveUsersCount }}</span>
      <span class="stat-label">Inactifs</span>
    </div>
  </div>
  <!-- Loading -->
  <div *ngIf="isLoading" class="loading">Chargement...</div>

  <!-- Table -->
  <div class="table-container" *ngIf="!isLoading">
    <table>
      <thead>
        <tr>
          <th>Utilisateur</th>
          <th>Email</th>
          <th>T√©l√©phone</th>
          <th>R√¥le</th>
          <th>Chantier</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of filteredUsers" [class.inactive]="!user.is_active">
          <td class="user-cell">
            <div class="user-avatar">{{ user.first_name[0] }}{{ user.last_name[0] }}</div>
            <div class="user-info">
              <span class="user-name">{{ user.first_name }} {{ user.last_name }}</span>
            </div>
          </td>
          <td>{{ user.email }}</td>
          <td>{{ user.phone || '-' }}</td>
          <td>
            <span 
              class="role-badge" 
              [style.background-color]="getRoleInfo(user.role)?.color || '#666'"
            >
              {{ getRoleInfo(user.role)?.icon }} {{ getRoleInfo(user.role)?.name || user.role }}
            </span>
          </td>
          <td>{{ getChantierNom(user.chantier_id) }}</td>
          <td>
            <span class="status-badge" [class.active]="user.is_active" [class.inactive]="!user.is_active">
              {{ user.is_active ? '‚úÖ Actif' : '‚ùå Inactif' }}
            </span>
          </td>
          <td class="actions">
            <button class="btn-icon" (click)="openEditModal(user)" title="Modifier">‚úèÔ∏è</button>
            <button 
              class="btn-icon" 
              (click)="toggleUserStatus(user)" 
              [title]="user.is_active ? 'D√©sactiver' : 'Activer'"
            >
              {{ user.is_active ? 'üîí' : 'üîì' }}
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="filteredUsers.length === 0" class="empty-state">
      Aucun utilisateur trouv√©
    </div>
  </div>

  <!-- Modal Cr√©ation -->
  <div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>‚ûï Nouvel Utilisateur</h2>
        <button class="btn-close" (click)="closeModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label>Pr√©nom *</label>
            <input type="text" [(ngModel)]="newUser.first_name" placeholder="Pr√©nom" />
          </div>
          <div class="form-group">
            <label>Nom *</label>
            <input type="text" [(ngModel)]="newUser.last_name" placeholder="Nom" />
          </div>
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" [(ngModel)]="newUser.email" placeholder="email@exemple.com" />
        </div>
        <div class="form-group">
          <label>Mot de passe *</label>
          <input type="password" [(ngModel)]="newUser.password" placeholder="Minimum 8 caract√®res" />
        </div>
        <div class="form-group">
          <label>T√©l√©phone</label>
          <input type="tel" [(ngModel)]="newUser.phone" placeholder="+221 77 000 00 00" />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>R√¥le *</label>
            <select [(ngModel)]="newUser.role">
              <option *ngFor="let role of roles" [value]="role.code">
                {{ role.icon }} {{ role.name }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label>Chantier assign√©</label>
            <select [(ngModel)]="newUser.chantier_id">
              <option [ngValue]="undefined">-- Aucun --</option>
              <option *ngFor="let chantier of chantiers" [ngValue]="chantier.id">
                {{ chantier.nom }}
              </option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeModal()">Annuler</button>
        <button class="btn-primary" (click)="createUser()" [disabled]="isSaving">
          {{ isSaving ? 'Cr√©ation...' : 'Cr√©er' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal √âdition -->
  <div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>‚úèÔ∏è Modifier {{ editingUser?.first_name }} {{ editingUser?.last_name }}</h2>
        <button class="btn-close" (click)="closeEditModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>R√¥le</label>
          <select [(ngModel)]="editRole">
            <option *ngFor="let role of roles" [value]="role.code">
              {{ role.icon }} {{ role.name }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>Chantier assign√©</label>
          <select [(ngModel)]="editChantierId">
            <option [ngValue]="undefined">-- Aucun --</option>
            <option *ngFor="let chantier of chantiers" [ngValue]="chantier.id">
              {{ chantier.nom }}
            </option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeEditModal()">Annuler</button>
        <button class="btn-primary" (click)="saveUserRole()" [disabled]="isSaving">
          {{ isSaving ? 'Sauvegarde...' : 'Sauvegarder' }}
        </button>
      </div>
    </div>
  </div>
</div>
